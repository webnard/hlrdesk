sudo: false
language: node_js
git:
  depth: 18 # arbitrarily set, but lower than the default of 50
node_js:
- '0.12'
cache:
  directories:
  - node_modules
before_install:
- pip install --user gsutil
- export PATH=$PATH:$HOME/.local/bin
- psql -c 'CREATE DATABASE travis;' -U postgres
- psql < core/db/schema.sql
- psql < core/db/mock-data.sql
- npm install -g codeclimate-test-reporter
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
after_success: >

 BR=$TRAVIS_BRANCH;
 PR=$TRAVIS_PULL_REQUEST;

 if [ "$PR" == "false" ] && ( [ "$BR" == "master" ] || [ "$BR" == "staging" ] ); then

    openssl aes-256-cbc -K $encrypted_430fe3a451cb_key -iv $encrypted_430fe3a451cb_iv -in .travis/travis_hlrdesk.enc -out ~/.ssh/id_rsa -d;
    chmod 600 ~/.ssh/id_rsa;

    git config --global user.email "travis@example.com";
    git config --global user.name "Travis CI Server";

    # see addons: ssh_known_hosts: ... in Travis-CI docs
    hosts="hlrdev.byu.edu hlrdesk.hlrdev.byu.edu hlrdesk-staging.byu.edu hlrdesk-prod.byu.edu";
    for i in $hosts; do ssh-keyscan -t rsa,dsa -H $i 2>&1 | tee -a $HOME/.ssh/known_hosts; done

    if [ "$TRAVIS_BRANCH" == "master" ]; then
      npm run deploy dev;
      codeclimate < coverage/lcov.info
    elif [ "$TRAVIS_BRANCH" == "staging"]; then
      npm run deploy staging;
      test ${TRAVIS_TAG} && npm run deploy production;
    fi

  fi

notifications:
  slack: hlrdev:GKTfYhesUBgIPeCNYx2qrKPP

# TODO: Travis won't let us conditionally use this in after_success
#addons:
#  ssh_known_hosts:
#  - hlrdesk.hlrdev.byu.edu
#  - hlrdesk-staging.byu.edu
#  - hlrdesk-prod.byu.edu
